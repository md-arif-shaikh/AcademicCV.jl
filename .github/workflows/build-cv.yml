name: Build CV

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-cv:
    name: Build Academic CV
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.12'
      
      - name: Install LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-extra
      
      - name: Install AcademicCV.jl
        run: |
          julia --project=. -e 'using Pkg; Pkg.instantiate()'
      
      - name: Build CV
        run: |
          julia --project=. examples/build_cv.jl
      
      - name: Upload CV PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: cv-pdf
          path: examples/output/*.pdf
      
      - name: Deploy PDF to cv-output branch
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create a temporary directory for the orphan branch
          mkdir -p /tmp/cv-output
          cp examples/output/cv.pdf /tmp/cv-output/ || echo "PDF not found, skipping deployment"
          
          # Check if PDF was copied
          if [ -f /tmp/cv-output/cv.pdf ]; then
            # Checkout orphan branch (create if doesn't exist)
            git fetch origin cv-output:cv-output || git checkout --orphan cv-output
            git checkout cv-output || git checkout --orphan cv-output
            
            # Remove all files from the orphan branch
            git rm -rf . || true
            
            # Copy the PDF
            cp /tmp/cv-output/cv.pdf .
            
            # Create a README for the branch
            cat > README.md << 'EOF'
          # CV Output
          
          This branch contains the automatically generated PDF output from the AcademicCV.jl package.
          
          ## View the PDF
          
          [Download cv.pdf](cv.pdf)
          
          ## About
          
          This file is automatically generated by GitHub Actions whenever changes are pushed to the main branch.
          See the [main branch](https://github.com/${{ github.repository }}) for the source code.
          
          **Last updated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF
            
            # Add and commit
            git add cv.pdf README.md
            git commit -m "Update CV PDF - $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
            
            # Push to cv-output branch
            git push origin cv-output --force
            
            echo "âœ… PDF deployed to cv-output branch"
            echo "ðŸ“„ View at: https://github.com/${{ github.repository }}/blob/cv-output/cv.pdf"
          else
            echo "âš ï¸ PDF file not found, skipping deployment"
          fi
